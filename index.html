<script>
    let isSending = false;
    let currentIndex = 0;
    let numbersArray = [];

    document.getElementById('send-bulk').addEventListener('click', startBulkSending);
    document.getElementById('stop-bulk').addEventListener('click', stopBulkSending);

    function startBulkSending() {
        const numbersText = document.getElementById('phone-numbers').value;
        const message = document.getElementById('bulk-message').value;
        const delay = document.getElementById('delay-time').value * 1000;
        
        numbersArray = numbersText.split('\n')
            .map(num => num.trim())
            .filter(num => num.length >= 10)
            .map(num => num.replace(/[^\d]/g, ''));
        
        if (numbersArray.length === 0) {
            alert('Please enter valid phone numbers');
            return;
        }
        
        if (!message.trim()) {
            alert('Please enter a message');
            return;
        }
        
        // Ask for confirmation
        if (!confirm(`Ready to send messages to ${numbersArray.length} numbers? Click OK to continue.`)) {
            return;
        }
        
        isSending = true;
        currentIndex = 0;
        
        document.getElementById('send-bulk').style.display = 'none';
        document.getElementById('stop-bulk').style.display = 'block';
        document.getElementById('progress-bar').style.display = 'block';
        
        processNextNumber();
    }

    function stopBulkSending() {
        isSending = false;
        document.getElementById('send-bulk').style.display = 'block';
        document.getElementById('stop-bulk').style.display = 'none';
        document.getElementById('bulk-status').innerHTML += '<p>‚èπÔ∏è Bulk sending stopped</p>';
    }

    async function processNextNumber() {
        if (!isSending || currentIndex >= numbersArray.length) {
            if (currentIndex >= numbersArray.length) {
                document.getElementById('bulk-status').innerHTML += '<p style="color: green;">üéâ Bulk sending completed!</p>';
            }
            stopBulkSending();
            return;
        }
        
        const number = numbersArray[currentIndex];
        const message = document.getElementById('bulk-message').value;
        const delay = document.getElementById('delay-time').value * 1000;
        
        // Update progress
        const progress = ((currentIndex + 1) / numbersArray.length) * 100;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        
        document.getElementById('bulk-status').innerHTML = 
            `Opening WhatsApp for ${currentIndex + 1}/${numbersArray.length}: +91 ${number}`;
        
        // Create WhatsApp link
        const whatsappLink = `https://wa.me/91${number}?text=${encodeURIComponent(message)}`;
        
        // Open WhatsApp in new tab
        const newTab = window.open(whatsappLink, '_blank');
        
        currentIndex++;
        
        // Wait before next number
        setTimeout(processNextNumber, delay);
    }
</script>
